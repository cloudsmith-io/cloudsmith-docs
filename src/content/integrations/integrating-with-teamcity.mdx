
import { BlockImage, Note } from '@/components';
import NoCodeNoteSnippet from '@/snippets/noCodeUploadingNoteSnippet.mdx';


import teamCityParameters from './images/teamcity/teamCityParameters.png';
import teamCityBuildConfig from './images/teamcity/teamCityBuildConfig.png';

# TeamCity

_How to integrate TeamCity with Cloudsmith_

Integrating TeamCity with Cloudsmith enables seamless management of your software packages within your CI/CD pipelines. This integration allows you to push build artifacts directly to Cloudsmith repositories from TeamCity, leveraging TeamCityâ€™s build pipelines for efficient artifact publishing.

<Note variant="note">
The Cloudsmith CLI gives you full control when connecting to any CI/CD process; allowing you to upload any of our support formats or query your repositories. Just configure your API Key, install the CLI, and you'll be all set.
</Note>

## Prerequisites

Before proceeding, ensure you have the following:

1. **TeamCity Server**: A functioning installation of TeamCity.
2. **Cloudsmith Account**: An active Cloudsmith account with the necessary repository access.
3. **API Key**: A Cloudsmith API key for authentication, obtainable from your Cloudsmith account under Account > API Settings.
4. **Build Agent**: A configured build agent to execute TeamCity builds.

***

## Integration Steps

Go to Project Build Configuration in TeamCity and add the following build steps:

### Step 1: Install Python

- Runner Type: Command Line
- Custom Script: 

  ```bash
  apt-get update -y
  apt-get install -y python3 python3-pip
  ```
- Execution Policy: If all previous steps finished successfully.

<Note variant="note">
ðŸ“˜ You can skip this step if the build agent is consistent as Python installation is a one-time setup.
</Note>

### Step 2: Install Cloudsmith CLI

- Runner Type: Command Line
- Custom Script: 

  ```bash
  pip install cloudsmith-cli
  ```

- Execution Policy: If all previous steps finished successfully.

### Step 3: Add Cloudsmith API Key Parameter

1. Navigate to **Project Settings > Parameters**.
2. Add the following parameter:
   - **Name**: env.CLOUDSMITH_API_KEY
   - **Kind**: Environment variable(env.)
   - **Value Type**:  Password (to ensure security).
   - **Value**: Your Cloudsmith API key.

<BlockImage src={teamCityParameters} alt="teamCityParameters"></BlockImage>

### Step 4: Push Your Artifacts

- Runner Type: Command Line
- Custom Script: 

  ```bash
  cloudsmith push raw <owner>/<your-repository> <artifact-path> 
  ```
- Replace `<owner>/<your-repository>` and `<artifact-path>` with:
  - Replace `<owner>` with your Cloudsmith Organisation name.
  - **Your Cloudsmith Repository Name**: For example, `my-repository`.
  - **Artifact Path**: Artifact path, such as `./example-artifact.tar.gz`.
- Execution Policy: If all previous steps finished successfully.

## Enable Versioned Settings in TeamCity

<Note>ðŸ“˜ Optional: execute the next step only if you want to track build configuration in your VCS.</Note>

1. In Project Settings, navigate to Versioned Settings.
2. Configure the following options:
   1. **Synchronization**: Enable.
   2. **Project settings VCS root**: Set as per your preference.
   3. **Settings format**: Choose either from Kotlin or XML.
   4. **Settings path in VCS**: .teamcity
   5. **Allow editing project settings via UI**: Enable.
   6. **Store passwords and API tokens outside of VCS**: Enable.
3. Apply the changes to ensure your build configuration is tracked in the version control system (VCS).
4. Allow it to complete and then hit Commit current project settings button and TeamCity will commit the build configuration to your VCS.

<BlockImage src={teamCityBuildConfig} alt="Build config"></BlockImage>

**Here's a Kotlin Snip for You Reference**

```kotlin
import jetbrains.buildServer.configs.kotlin.*
import jetbrains.buildServer.configs.kotlin.buildFeatures.perfmon
import jetbrains.buildServer.configs.kotlin.buildSteps.script
import jetbrains.buildServer.configs.kotlin.triggers.vcs

version = "2024.03"

project {

    buildType(TestCloudsmith)
}

object TestCloudsmith : BuildType({
    name = "TestCloudsmith"

    artifactRules = "./"

    params {
        password("env.CLOUDSMITH_API_KEY", "credentialsJSON:4ad9ee86-2dd4-4acf-8070-123e96c647fc")
    }

    vcs {
        root(DslContext.settingsRoot)
    }

    steps {
        script {
            name = "InstallPython"
            id = "InstallCloudsmith"
            scriptContent = """
                apt-get update -y
                apt-get install -y python3 python3-pip
            """.trimIndent()
        }
        script {
            name = "InstallCloudsmith"
            id = "InstallCloudsmith"
            scriptContent = "pip3 install cloudsmith-cli"
        }
        script {
            name = "CheckCloudsmithAuth"
            id = "CheckCloudsmithAuth"
            scriptContent = "cloudsmith whoami"
        }
        script {
            name = "Cloudsmith Push"
            id = "Cloudsmith_Push"
            scriptContent = "cloudsmith push raw testenv/rawrepo raw-example.tar.gz"
        }
    }

    triggers {
        vcs {
        }
    }

    features {
        perfmon {
        }
    }
})

```

***

## Best Practices

- **Use Entitlement token Authentication**: If you only need to pull packages, use Entitlement tokens for authentication to avoid using long-lived API keys.
- **Secure Secrets**: Store sensitive information like API keys/Entitlement tokens as Passwords instead of any other Value type.

## Troubleshooting

- **Authentication Issues**: Verify the API key is correctly configured as a hidden parameter.
- **Artifact Upload Errors**: Ensure owner/your-repository and artifact-path are properly specified in the push command.
- **Build Failures**: Review the TeamCity build logs for errors in specific steps.