import { Note, BlockImage, Card } from '@/components';
export const parentTitle = 'Integrations';

import bitbucketPipeCloudsmithPublishImage from './images/bitbucket/bitbucket-pipe-cloudsmith-publish.png'
import bitbucketCloudsmithApiKeyImage from './images/bitbucket/bitbucket_cloudsmith_api_key.png'
import cloudsmithBitbucketPipelineImage from './images/bitbucket/cloudsmith_bitbucket_pipeline.png'
import cloudsmithBitbucketPipelineUiImage from './images/bitbucket/cloudsmith_bitbucket_pipeline_ui.png'
import cloudsmithBitbucketUploadImage from './images/bitbucket/cloudsmith_bitbucket_upload.png'


# Integrating Bitbucket Pipelines

How to integrate Bitbucket Pipelines with Cloudsmith


Cloudsmith provides first-class support for Bitbucket Pipelines with our official **Cloudsmith Publish** pipe. Using the pipe, Bitbucket users can easily integrate publishing to Cloudsmith with their existing pipeline workflows.

<Card
    title="cloudsmith-pipes-publish"
    description="Bitbucket Pipe for publishing artifacts"
    href="https://bitbucket.org/cloudsmith-io/publish/"
    linkText=""
    icon="utility/documentation"
  />

<BlockImage src={bitbucketPipeCloudsmithPublishImage} alt=""></BlockImage>

Content below first appeared on the [Atlassian Community Blog](https://community.atlassian.com/t5/Marketplace-Apps-Integrations/Cloudsmith-Bitbucket/ba-p/1148691).

## Using Pipelines

The Cloudsmith pipe is included in Bitbucket's collection of officially maintained pipes and is available by default for any user that wishes to include it in their pipeline.

To use the pipe you'll first need an application or library that can be packaged into one of the formats that Cloudsmith support. You can see examples of Python and Javascript libraries in [Cloudsmith's Bitbucket account](https://bitbucket.org/cloudsmith-io/?_ga=2.35066210.2132496434.1565627316-1859711499.1556636245).

For the purposes of this example we'll assume you're using the Python example from the link above.

First, ensure that you can package your code using a Bitbucket pipeline by editing bitbucket-pipelines.yml in your repository. You can do so either via Bitbucket's web UI or using your normal editor and Git workflow.

For the example library, a basic pipeline that builds a package when a new tag is created looks like so:

```text
image:
  name: atlassian/default-image:2

build: &build
  step:
    name: Build Python Package
    image: python:3.7
    script:
    - python setup.py sdist
    artifacts:
    - dist/**

pipelines:
  tags:
    release-*:
    - <<: *build
```

This pipeline will build a new package each time you push an appropriate tag you your Bitbucket repository. The built package is then discarded as we have not yet added further instructions to tell Bitbucket what to do with it.

## Configuring the Pipe

Next we'll add publish the package to Cloudsmith using our official pipe. We'll need to provide an API Key that the pipe can use to authenticate with Cloudsmith. You can find the official documentation for pipeline variables in the [Bitbucket documentation](https://confluence.atlassian.com/bitbucket/variables-in-pipelines-794502608.html?_ga=2.261427278.2132496434.1565627316-1859711499.1556636245).

The API Key should be added as a "secure" variable (so it doesn't leak into logs) with the name `CLOUDSMITH_API_KEY`.
<BlockImage src={bitbucketCloudsmithApiKeyImage} alt=""></BlockImage>

Once authentication is configured, you can add the pipe configuration to your pipeline.

If using the web UI to configure your pipeline, you can select the Cloudsmith pipe right from your browser, from within the list of supported pipes as in the image below:
<BlockImage src={cloudsmithBitbucketPipelineImage} alt=""></BlockImage>

If using your local editor, you can follow the instructions in the [official README on Bitbucket](https://bitbucket.org/cloudsmith-io/publish?_ga=2.189666536.2132496434.1565627316-1859711499.1556636245).

Once added, your pipeline YAML should look something like so:

```text
image:
  name: atlassian/default-image:2

build: &build
  step:
    name: Build Python Package
    image: python:3.7
    script:
    - python setup.py sdist
    artifacts:
    - dist/**

publish: &publish
  step:
    name: Publish Python Package
    script:
    - pipe: cloudsmith-io/publish:0.1.1
      variables:
        CLOUDSMITH_REPOSITORY: 'cloudsmith/examples'
        CLOUDSMITH_API_KEY: $CLOUDSMITH_API_KEY
        PACKAGE_FORMAT: 'python'
        PACKAGE_PATH: 'dist/*.tar.gz'

pipelines:
  tags:
    release-*:
    - <<: *build
    - <<: *publish
```

This configuration instructs the pipe to push artifacts to the [cloudsmith/examples](https://app.cloudsmith.com/cloudsmith/examples) repository, with the API key we stored earlier. We're uploading a python package which is located at dist/\*.tar.gz.

## Using the Pipe

Your pipe is now configured and ready to run. You should be able to push a new tag to Bitbucket and see your pipe run.

Bitbucket's pipeline UI provides a great overview of the status of your jobs:
<BlockImage src={cloudsmithBitbucketPipelineUiImage} alt=""></BlockImage>

Once pushed, you should see your new package in the Cloudsmith UI, ready for download and install using your preferred tools:

<BlockImage src={cloudsmithBitbucketUploadImage} alt=""></BlockImage>

## Conclusion

Cloudsmith's Bitbucket pipe provides the easiest and simplest way for Bitbucket users to push their assets to [Cloudsmith](https://cloudsmith.com/). Get started now.

<Note variant="note" headline="Officially Maintained">
Our official pipe is maintained by the Cloudsmith team and you can be sure it'll be kept up to date with all changes and features as we release them.
</Note>
