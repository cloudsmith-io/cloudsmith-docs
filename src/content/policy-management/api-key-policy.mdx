import { Note, BlockImage } from '@/components'
import img_api_key_policies from './images/api-key-policy/968354c3784e9cf543591c4d432d35902ca80caa4617a4840204e69cea5df8a1-api-key-policies.png'
import img_api_key_policies_2 from './images/api-key-policy/458fb4315f9da55ac80d898f0f41a5910256f6bd550718dd3b5783247a32919b-api-key-policies-2.png'
import img_api_key_refreshv2 from './images/api-key-policy/1aff04357788e8383754d7e927c208b63650165ba77cea164b2793058177bc4d-api-key-refreshv2.png'
import img_automatically_refresh from './images/api-key-policy/8bd8870f1c66a205315c5937a98403d8fc6cb58c6778968115cf669fb7707991-automatically-refresh.png'
import img_refresh_immediately from './images/api-key-policy/eeebfd89e143f3cda6be80517d2aad357454e93c039cb48d380b16b256e5a14f-refresh-immediately.png'
import img_disable_api_key_policy from './images/api-key-policy/ff914822a6436fde7f9b860a1857ab40d53d3ebcb01d5e1a65f1357b76402801-disable-api-key-policy.png'
import img_confirmed_disabled from './images/api-key-policy/e6c8ed318a1507a5f21eabddbe6f3e2f7a956be5b5f8e902fee477b0c5147705-confirmed-disabled.png'

# API Key Policy

## API Key Policy Overview

The API key policy allows workspaces to customize the maximum age of API keys across all workspace accounts, by specifying the duration after which keys should be rotated. Frequent API Key rotation ensures that API keys older than the designated age are invalidated for authentication, with the added flexibility to enforce a refresh for keys that exceed the specified duration.

## View API Key Policy

To view your workspace's API Key Policy, go to your Workspace settings > Manage policies and select Authentication Policies from the left-hand menu.

<Note variant="note">
  The API Key Policy is disabled by default.
</Note>

<BlockImage src={img_api_key_policies} alt="API Key Policy"></BlockImage>

## Enable API Key Policy

To enable the API Key Policy, set the "Maximum permitted age (hours)" field and click "Update policy".

<BlockImage src={img_api_key_policies_2} alt="Enable API Key Policy"></BlockImage>

|||
|:---|:---|
|**Maximum permitted age (hours)**|The maximum permitted age of an account's API key.<br /><br />Note: the minimum value this can be set to is “24”.|
|**Days**|Read-only field, displaying the value of "Maximum permitted age (hours)" field in days.<br /><br />For example, if the "Maximum permitted age (hours)" field is set to “720” hours, this field will display “30” days.|
|**Enforce automatic API key refresh**|Enable to automatically refresh API keys that violate the policy. Take extreme caution when enabling this option, as this cannot be undone.<br /><br />See section [ Enforce Automatic API Key Refresh](/getting-started/api-key-policy#enforce-automatic-api-key-refresh) for further details.|

Once the policy is enabled, permission will be revoked for any API key older than the specified maximum age. This applies to all accounts associated with the workspace, including members, managers, owners, service accounts, and collaborators.

If a user attempts to utilize an API key that violates the policy, they will receive a "permission denied" error message

To regain access, the user should update their [API Key](/getting-started/api-key) by clicking "Refresh" within the API settings page. 

<BlockImage src={img_api_key_refreshv2} alt="Refresh API Key"></BlockImage>

### Enforce Automatic API key Refresh

<Note variant="warning" headline="API key refresh">
  Exercise extreme care when utilizing this option, as refreshing an API key is an irreversible action.
</Note>

To automatically force refresh an API key that violates the policy, enable "Enforce automatic API key refresh".

<Note variant="note">
  This force refreshes API keys of all users (member, manager, owners and service accounts) that violate the policy, except for collaborators.
</Note>

<BlockImage src={img_automatically_refresh} alt="Enable API Key Policy with enforced automatic API key refreshing"></BlockImage>

<Note variant="note">
  The process of force refreshing all API keys may take up to 60 minutes to complete.
</Note>

To enforce an immediate refresh of API keys that violate the policy, enable both the "Enforce automatic API key refresh" and "Refresh immediately" options. 

<BlockImage src={img_refresh_immediately} alt="Enable immediate for refresh of API keys"></BlockImage>

## Disable API Key Policy

To disable the API key policy, clear the value within the "Maximum permitted age (hours)" field and click "Update policy".

<BlockImage src={img_disable_api_key_policy} alt="Disable API Key Policy"></BlockImage>

<br />

The UI will then update to confirm the Policy has been disabled. 

<BlockImage src={img_confirmed_disabled} alt="Disabled Confirmation"></BlockImage>

Once disabled, restrictions to API keys that previously violated the policy are lifted and these API keys will become operational again. 

## Members of Multiple Workspaces

If a user is a member of multiple workspaces the user's permissions will only be revoked for the workspace where the API key policy is enforced and their API key violates the policy. Their permissions in all other workspaces are unaffected.

However, if the user is a member of a workspace which also has "Enforce automatic API key refresh" enabled, the user's API key will be refreshed across all their workspaces.

## Notifications

When an API key is approaching its expiration age, users will receive a notification at least 24 hours in advance. This notification will be sent via email and will also appear as a notification when they log into the application.

Additionally, users will receive an email and UI notification when their API key has expired.

If the API policy is enabled and "Enforce automatic API key refresh" is set, users will also receive an email notification when their API key has been refreshed. This email will include details about the user who initiated the refresh process.

For service accounts, the creator of the service account will receive an email notification informing them of the upcoming expiration of the service's API key. The email also provides a URL that the user can use to reset the API key. Additionally, when the creator logs into the application's user interface, they receive a warning message.

If a service account has been created by another service account, no email notification will be sent for an upcoming API key expiration. In this scenario, with the API Key Policy enabled, you can use the [Get a list of all services within a workspace](/api/services/list) REST API call to retrieve your services, and find each respective key expiry in the `key_expires_at` field.

## Audit Logs

All actions and notifications related to the API Key Policy are also logged within the Audit logs. 

In scenarios where a user is a member of multiple workspaces, it is important to note that the user who enforces the API key refresh will only be visible as the initiator within the workspace where they hold the ownership role. In other workspaces where the user is a member, the API key refresh action will still be recorded in the audit logs. However, the user who enforced the refresh will be obscured, and the action will be listed as a "refreshed API key" rather than an "enforced API key refresh."
